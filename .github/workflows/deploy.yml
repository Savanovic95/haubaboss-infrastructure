name: Deploy Full Stack

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy_frontend:
        description: 'Deploy frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy backend'
        required: true
        default: true
        type: boolean
      run_migrations:
        description: 'Run database migrations'
        required: true
        default: true
        type: boolean

jobs:
  deploy:
    name: Deploy Infrastructure & Apps
    runs-on: ubuntu-latest
    # environment: production  # Uncomment to require approval before deploy
    steps:
      - name: Checkout infrastructure
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd /var/www/haubaboss
            chmod +x scripts/*.sh
            echo "Pulling repositories..."
            if [ -d "haubaboss-frontend/.git" ]; then
              cd haubaboss-frontend && git fetch origin && git reset --hard origin/main && cd ..
            else
              rm -rf haubaboss-frontend
              git clone git@github.com:Savanovic95/haubaboss-frontend.git haubaboss-frontend
            fi
            if [ -d "haubaboss-backend/.git" ]; then
              cd haubaboss-backend && git fetch origin && git reset --hard origin/main && cd ..
            else
              rm -rf haubaboss-backend
              git clone git@github.com:Savanovic95/haubaboss-backend.git haubaboss-backend
            fi
            echo "Building containers..."
            source .env
            docker compose build --build-arg NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://89.167.24.255} --build-arg API_URL=http://nginx
            docker compose up -d
            sleep 10
            echo "Running migrations..."
            docker compose exec -T backend php artisan migrate --force || true
            docker compose exec -T backend php artisan config:cache || true
            docker compose exec -T backend php artisan route:cache || true
            docker compose exec -T backend php artisan view:cache || true
            docker compose exec -T backend php artisan storage:link 2>/dev/null || true
            echo "Deployment complete!"

      - name: Health check
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
        run: |
          sleep 10
          echo "Checking frontend..."
          curl -f http://${SERVER_IP}/ || echo "Frontend check failed"
          echo "Checking API..."
          curl -f http://${SERVER_IP}/api/v1/health || echo "API health check failed"

      - name: Notify success
        if: success()
        run: echo "✅ Full stack deployed successfully to production"

      - name: Notify failure
        if: failure()
        run: echo "❌ Deployment failed - check logs above"
# Triggered at Thu Jan 29 19:42:06 CET 2026
